import{c as f}from"./token.guard-C10oOflc.js";async function s(n,t={}){const e=localStorage.getItem("access_token");if(!e)throw window.location.href="/html/login.html",new Error("No autenticado");const r={Authorization:`Bearer ${e}`,...t.headers};t.body instanceof FormData||(r["Content-Type"]="application/json"),t.body&&(t.body instanceof FormData||typeof t.body=="object"&&(r["Content-Type"]="application/json",t.body=JSON.stringify(t.body)));const i=await fetch(`https://agenda-1-zomu.onrender.com/api/v1${n}`,{...t,headers:r});if(!i.ok){const a=await i.json().catch(()=>({}));throw console.error("API ERROR:",a),a}return i.json()}const d="/turnos";function p(n){return s(`${d}?fecha=${n}`)}function g(n){return s(d,{method:"POST",body:JSON.stringify(n)})}function T(n){return s(`${d}/${n}/cancelar`,{method:"PATCH"})}class y{constructor({id:t,numeroTicket:e,tipoTurno:r,rangoHorario:i,estado:a,fecha:o,horaInicio:c,horaFin:u,cliente:h,tecnico:m}){this.id=t,this.numeroTicket=e,this.tipoTurno=r,this.rangoHorario=i,this.estado=a.toLowerCase(),this.fecha=o,this.horaInicio=c,this.horaFin=u,this.cliente=h,this.tecnico=m}estaCancelado(){return this.estado==="cancelado"}duraEnMinutos(){const[t,e]=this.horaInicio.split(":").map(Number),[r,i]=this.horaFin.split(":").map(Number);return r*60+i-(t*60+e)}}function l(n){return new y({id:n.id,numeroTicket:n.numero_ticket,tipoTurno:n.tipo_turno,rangoHorario:n.rango_horario,estado:n.estado,fecha:new Date(n.fecha),horaInicio:n.hora_inicio,horaFin:n.hora_fin,cliente:E(n.cliente),tecnico:b(n.tecnico)})}function E(n){return n?{id:n.id,numeroCliente:n.numero_cliente,nombre:n.nombre}:null}function b(n){return n?{id:n.id,nombre:n.nombre}:null}function w(n){return{numero_ticket:n.numeroTicket,cliente_id:n.cliente.id,tecnico_id:n.tecnico.id,tipo_turno:n.tipoTurno,rango_horario:n.rangoHorario,estado:n.estado,fecha:n.fecha.toISOString().split("T")[0],hora_inicio:n.horaInicio,hora_fin:n.horaFin}}function v(n){if(!n.cliente?.id)throw new Error("Cliente inválido");if(!n.tecnico?.id)throw new Error("Técnico inválido");if(n.horaInicio>=n.horaFin)throw new Error("Horario inválido")}async function I(n){const t=await p(n);return Array.isArray(t)?t.map(l):[]}async function C(n){v(n);const t=w(n),e=await g(t);return l(e)}async function B(n){const t=await T(n);return l(t)}function L(n){const t=new URLSearchParams(n);return{clienteId:t.get("cliente"),ticketId:t.get("ticket")}}class S{constructor(){this.initialState={fechaSeleccionada:null,turnos:[],loading:!1,error:null},this.state=structuredClone(this.initialState),this.listeners=[]}subscribe(t){return this.listeners.push(t),()=>{this.listeners=this.listeners.filter(e=>e!==t)}}notify(){const t=this.getState();this.listeners.forEach(e=>e(t))}getState(){return structuredClone(this.state)}update(t){this.state={...this.state,...t},this.notify()}setLoading(t){this.update({loading:t})}setError(t){const e=t?.message??String(t);this.update({error:e})}clearError(){this.update({error:null})}setFecha(t){this.update({fechaSeleccionada:t})}setTurnos(t){this.update({turnos:[...t]})}addTurno(t){this.update({turnos:[...this.state.turnos,t]})}cancelTurno(t){this.update({turnos:this.state.turnos.map(e=>e.id===t?{...e,estado:"cancelado"}:e)})}reset(){this.state=structuredClone(this.initialState),this.notify()}hasTurnos(){return this.state.turnos.length>0}isEmpty(){return!this.state.loading&&this.state.turnos.length===0}}async function k({tecnicoId:n,fecha:t,token:e}){return s(`/disponibilidad?tecnico_id=${n}&fecha=${t}`,{method:"GET",headers:{Authorization:`Bearer ${e}`}})}class O{constructor({view:t}){this.view=t,this.state=new S}async init(){this.bindState(),this.bindEvents();const t=this.view.getSearchString(),e=L(t);this.view.applyParamsToSelects(e)}bindState(){this.state.subscribe(t=>{this.view.setLoading(t.loading),this.view.renderError(t.error),this.view.renderTurnos(t.turnos)})}bindEvents(){this.view.onBuscarTurnos(t=>this.handleBuscarTurnos(t)),this.view.onCrearTurno(t=>this.handleCrearTurno(t)),this.view.onCancelarTurno(t=>this.handleCancelarTurno(t))}async handleBuscarTurnos(t){this.state.setLoading(!0),this.state.clearError();try{const e=await I(t);this.state.update({fechaSeleccionada:t,turnos:e})}catch(e){this.state.setError(e)}finally{this.state.setLoading(!1)}}async handleCrearTurno(t){this.state.setLoading(!0),this.state.clearError();try{const e=await C(t);this.state.addTurno(e)}catch(e){this.state.setError(e)}finally{this.state.setLoading(!1)}}async handleCancelarTurno(t){this.state.setLoading(!0),this.state.clearError();try{const e=await B(t);this.state.replaceTurno(e)}catch(e){this.state.setError(e)}finally{this.state.setLoading(!1)}}async handleBuscarDisponibilidad({tecnicoId:t,fecha:e}){this.state.setLoading(!0),this.state.clearError();try{const r=await k({tecnicoId:t,fecha:e});this.view.renderDisponibilidad(r)}catch(r){this.state.setError(r)}finally{this.state.setLoading(!1)}}}class _{getSearchString(){return window.location.search}applyParamsToSelects({clienteId:t,ticketId:e}){const r=document.getElementById("selectCliente"),i=document.getElementById("selectTicket");r&&t&&this.selectOrCreateOption(r,t),i&&e&&this.selectOrCreateOption(i,e,`Ticket ${e}`)}selectOrCreateOption(t,e,r=e){if(Array.from(t.options).find(o=>o.value==e)){t.value=e;return}const a=document.createElement("option");a.value=e,a.textContent=r,a.selected=!0,t.appendChild(a)}setLoading(t){const e=document.getElementById("spinner");e&&(e.style.display=t?"block":"none")}renderError(t){const e=document.getElementById("errorBox");e&&(e.textContent=t??"")}renderTurnos(t){const e=document.getElementById("turnosContainer");if(e){if(e.innerHTML="",!t||t.length===0){e.innerHTML="<p>No hay turnos para esta fecha</p>";return}t.forEach(r=>{const i=document.createElement("div");i.classList.add("turno-item"),i.innerHTML=`
        <span>${r.fecha} ${r.hora}</span>
        <button data-id="${r.id}" class="cancelar-btn">
          Cancelar
        </button>
      `,e.appendChild(i)})}}renderDisponibilidad(t){const e=document.getElementById("disponibilidadContainer");if(e){if(e.innerHTML="",!t||t.length===0){e.innerHTML="<p>No hay disponibilidad para esta fecha</p>";return}t.forEach(r=>{const i=document.createElement("button");i.textContent=r.hora,i.disabled=!r.disponible,i.classList.add("slot-btn"),i.addEventListener("click",()=>{const a=document.getElementById("horaInput");a&&r.disponible&&(a.value=r.hora)}),e.appendChild(i)})}}onBuscarTurnos(t){const e=document.getElementById("buscarTurnosForm");e&&e.addEventListener("submit",r=>{r.preventDefault();const i=document.getElementById("fechaInput");i&&t(i.value)})}onCrearTurno(t){const e=document.getElementById("crearTurnoForm");e&&e.addEventListener("submit",r=>{r.preventDefault();const i=document.getElementById("fechaInput")?.value,a=document.getElementById("horaInput")?.value,o=document.getElementById("selectCliente")?.value,c=document.getElementById("selectTicket")?.value,u=document.getElementById("selectTecnico")?.value;t({fecha:i,hora:a,clienteId:o,ticketId:c,tecnicoId:u})})}onCancelarTurno(t){const e=document.getElementById("turnosContainer");e&&e.addEventListener("click",r=>{const i=r.target.closest(".cancelar-btn");if(!i)return;const a=i.dataset.id;t(a)})}onBuscarDisponibilidad(t){const e=document.getElementById("btnDisponibilidad");e&&e.addEventListener("click",()=>{const r=document.getElementById("selectTecnico")?.value,i=document.getElementById("fechaInput")?.value;!r||!i||t({tecnicoId:r,fecha:i})})}}function A(){const n=new _;new O({view:n,tokenProvider:{getToken:()=>localStorage.getItem("token")}}).init()}document.addEventListener("DOMContentLoaded",async()=>{await f()&&A()});
