import"./token.guard-C10oOflc.js";/* empty css             */import{t as T}from"./formularios_tablas-DeWFMYwk.js";class _{constructor(e,o){this.form=document.querySelector(e),this.container=document.querySelector(o),this.horariosContainer=this.form.querySelector(o),this.btnAddHorario=this.form.querySelector("#addHorario"),this.btnAddHorario.addEventListener("click",()=>this.agregarFilaHorario())}agregarFilaHorario(e={}){const o=document.createElement("div");o.classList.add("horario-row"),o.innerHTML=`
      <select class="dia">
        <option value="0">Domingo</option>
        <option value="1">Lunes</option>
        <option value="2">Martes</option>
        <option value="3">Mi√©rcoles</option>
        <option value="4">Jueves</option>
        <option value="5">Viernes</option>
        <option value="6">S√°bado</option>
      </select>
      <input type="time" class="inicio">
      <input type="time" class="fin">
      <button type="button" class="remove">üóëÔ∏è</button>
    `,e.diaSemana!==void 0&&(o.querySelector(".dia").value=e.diaSemana),e.horaInicio&&(o.querySelector(".inicio").value=e.horaInicio.slice(0,5)),e.horaFin&&(o.querySelector(".fin").value=e.horaFin.slice(0,5)),o.querySelector(".remove").addEventListener("click",()=>o.remove()),this.horariosContainer.appendChild(o)}recopilarHorarios(){const e=this.horariosContainer.querySelectorAll(".horario-row");return Array.from(e).filter(o=>o.querySelector(".inicio").value&&o.querySelector(".fin").value).map(o=>({diaSemana:Number(o.querySelector(".dia").value),horaInicio:o.querySelector(".inicio").value+":00",horaFin:o.querySelector(".fin").value+":00"}))}reset(){this.horariosContainer.innerHTML=""}renderHorarios(e){this.reset(),e.forEach(o=>this.agregarFilaHorario(o))}}class q{constructor(){this.form=document.querySelector("#formGeneral"),this.tableBody=document.querySelector("#generalContainer"),this.inputs={nombre:this.form.querySelector("#nombre"),apellido:this.form.querySelector("#apellido"),email:this.form.querySelector("#duracionEmail"),telefono:this.form.querySelector("#telefono"),duracionTurno:this.form.querySelector("#duracionTurno"),imagen:this.form.querySelector("#imagen"),previewImagen:this.form.querySelector("#previewImagen")},this.btnSubmit=this.form.querySelector("#btnSubmit"),this.btnCancel=this.form.querySelector("#btnCancel"),this.disponibilidadView=new _("#formGeneral","#listaHorarios")}onSubmit(e){this.form.addEventListener("submit",o=>{o.preventDefault();const n=this._recopilarDatosFormulario();e(n)})}onEdit(e){this._onEdit=e}onDelete(e){this._onDelete=e}render(e){if(this.tableBody.innerHTML="",!e.length){this.tableBody.innerHTML='<tr><td colspan="7">No hay registros</td></tr>';return}const o=["Domingo","Lunes","Martes","Mi√©rcoles","Jueves","Viernes","S√°bado"];e.forEach(n=>{const t=document.createElement("tr"),r=(n.horarios||[]).map(a=>`${o[a.diaSemana]} ${a.horaInicio.slice(0,5)}-${a.horaFin.slice(0,5)}`).join("<br>");t.innerHTML=`
        <td>${n.imagenUrl?`<img src="${n.imagenUrl}" class="foto-tecnico">`:"‚Äî"}</td>
        <td>${n.nombre}</td>
        <td>${n.apellido}</td>
        <td>${n.telefono||"-"}</td>
        <td>${n.duracionTurnoMin} min</td>
        <td>${r||"-"}</td>
        <td>
          <button type="button" class="btn-edit">‚úèÔ∏è</button>
          <button type="button" class="btn-delete">üóëÔ∏è</button>
        </td>
      `,t.querySelector(".btn-edit").onclick=()=>this._onEdit?.(n.id),t.querySelector(".btn-delete").onclick=()=>this._onDelete?.(n.id),this.tableBody.appendChild(t)})}resetForm(){this.form.reset(),this.disponibilidadView.reset(),this.inputs.previewImagen.src="",this.inputs.previewImagen.style.display="none",this.btnCancel.style.display="none",this.btnSubmit.textContent="Guardar"}fillForm(e){this.inputs.nombre.value=e.nombre,this.inputs.apellido.value=e.apellido,this.inputs.email.value=e.email||"",this.inputs.telefono.value=e.telefono||"",this.inputs.duracionTurno.value=e.duracionTurnoMin,this.inputs.previewImagen.src=e.imagenUrl||"",this.inputs.previewImagen.style.display=e.imagenUrl?"block":"none",this.disponibilidadView.renderHorarios(e.horarios||[]),this.btnSubmit.textContent="Actualizar",this.btnCancel.style.display="inline-block"}_recopilarDatosFormulario(){return{nombre:this.inputs.nombre.value.trim(),apellido:this.inputs.apellido.value.trim(),email:this.inputs.email.value.trim(),telefono:this.inputs.telefono.value.trim(),duracionTurnoMin:Number(this.inputs.duracionTurno.value),imagen:this.inputs.imagen.files[0]||null,horarios:this.disponibilidadView.recopilarHorarios()}}}const l="https://agenda-1-zomu.onrender.com/api/v1";function d(i,e=!1){const o={Authorization:`Bearer ${i}`};return e||(o["Content-Type"]="application/json"),o}async function k(i){const e=await fetch(`${l}/tecnicos/`,{headers:d(i)}),o=await e.json();if(!e.ok)throw new Error(o.detail||"Error obteniendo t√©cnicos");return o}async function h(i,e,o=!1){const n=await fetch(`${l}/tecnicos/`,{method:"POST",headers:d(e,o),body:o?i:JSON.stringify(i)}),t=await n.json();if(!n.ok)throw new Error(t.detail||"Error creando t√©cnico");return t}async function m(i,e,o,n=!1){const t=await fetch(`${l}/tecnicos/${i}`,{method:"PUT",headers:d(o,n),body:n?e:JSON.stringify(e)}),r=await t.json();if(!t.ok)throw new Error(r.detail||"Error actualizando t√©cnico");return r}async function $(i,e){const o=await fetch(`${l}/tecnicos/${i}`,{method:"DELETE",headers:d(e)});if(!o.ok){const n=await o.json();throw new Error(n.detail||"Error eliminando t√©cnico")}return!0}class f{constructor({id:e=null,nombre:o,apellido:n,telefono:t,duracionTurnoMinutos:r,email:a,imagen:v=null,imagenUrl:g=null,horarios:S=[],activo:E=!0}){this.id=e,this.nombre=o.trim(),this.apellido=n.trim(),this.telefono=t?.trim()||"",this.duracionTurnoMinutos=Number(r),this.email=a?.trim()||"",this.imagen=v,this.imagenUrl=g,this.horarios=S,this.activo=E}}function s(i){return new f({id:i.id,nombre:i.nombre,apellido:i.apellido,telefono:i.telefono,duracionTurnoMinutos:i.duracion_turno_min,email:i.email,imagenUrl:i.imagen_url,horarios:i.horarios??[],activo:i.activo})}function b(i){return{nombre:i.nombre,apellido:i.apellido,telefono:i.telefono,duracion_turno_min:i.duracionTurnoMinutos,email:i.email,activo:i.activo,horarios:i.horarios}}async function D(i){return(await k(i)).map(s)}async function F(i,e){if(i.imagen instanceof File){const t=new FormData;t.append("nombre",i.nombre),t.append("apellido",i.apellido),t.append("telefono",i.telefono),t.append("duracion_turno_min",i.duracionTurnoMinutos),t.append("email",i.email),t.append("activo",i.activo),t.append("imagen",i.imagen),t.append("horarios",JSON.stringify(i.horarios));const r=await h(t,e,!0);return s(r)}const o=b(i),n=await h(o,e);return s(n)}async function I(i,e){if(i.imagen instanceof File){const t=new FormData;t.append("nombre",i.nombre),t.append("apellido",i.apellido),t.append("telefono",i.telefono),t.append("duracion_turno_min",i.duracionTurnoMinutos),t.append("email",i.email),t.append("activo",i.activo),t.append("imagen",i.imagen),t.append("horarios",JSON.stringify(i.horarios));const r=await m(i.id,t,e,!0);return s(r)}const o=b(i),n=await m(i.id,o,e);return s(n)}async function C(i,e){return $(i,e)}const c="https://agenda-1-zomu.onrender.com/api/v1";function u(i){return{"Content-Type":"application/json",Authorization:`Bearer ${i}`}}async function H(i,e){const o=await fetch(`${c}/tecnicos/${i}/disponibilidad`,{headers:u(e)}),n=await o.json();if(!o.ok)throw new Error(n.detail||"Error obteniendo disponibilidad");return n}async function M(i,e,o){const n=await fetch(`${c}/tecnicos/${i}/disponibilidad`,{method:"POST",headers:u(o),body:JSON.stringify(e)}),t=await n.json();if(!n.ok)throw new Error(t.detail||"Error creando disponibilidad");return t}async function A(i,e){const o=await fetch(`${c}/disponibilidad/${i}`,{method:"DELETE",headers:u(e)});if(!o.ok){const n=await o.json();throw new Error(n.detail||"Error eliminando disponibilidad")}return!0}class w{constructor({id:e=null,tecnicoId:o,diaSemana:n,horaInicio:t,horaFin:r}){this.id=e,this.tecnicoId=o,this.diaSemana=n,this.horaInicio=t,this.horaFin=r}esValida(){return!this.horaInicio||!this.horaFin?!1:this.horaInicio<this.horaFin}}function y(i){return new w({id:i.id,tecnicoId:i.tecnico_id,diaSemana:i.dia_semana,horaInicio:i.hora_inicio,horaFin:i.hora_fin})}function L(i){return{tecnico_id:i.tecnicoId,dia_semana:i.diaSemana,hora_inicio:i.horaInicio,hora_fin:i.horaFin}}async function p(i,e){return(await H(i,e)).map(y)}async function P(i,e){const o=L(i),n=await M(i.tecnicoId,o,e);return y(n)}async function j(i,e){return A(i,e)}class N{constructor({view:e,tokenProvider:o}){this.view=e,this.tokenProvider=o,this.tecnicos=[],this.editando=null}async init(){this.bindEvents(),await this.cargar()}bindEvents(){this.view.onSubmit(e=>this.handleGuardar(e)),this.view.onEdit(e=>this.handleEditar(e)),this.view.onDelete(e=>this.handleEliminar(e))}async cargar(){try{const e=this.tokenProvider.getToken();this.tecnicos=await D(e),this.view.render(this.tecnicos)}catch(e){this.view.showError(e.message)}}async handleGuardar(e){try{const o=this.tokenProvider.getToken(),n=new f({...e,id:this.editando?.id??null,activo:!0,horarios:[]});let t;if(!this.editando)t=await F(n,o);else{t=await I(n,o);const r=await p(t.id,o);await Promise.all(r.map(a=>j(a.id,o))),this.editando=null}e.horarios&&e.horarios.length&&await Promise.all(e.horarios.map(r=>P(new w({tecnicoId:t.id,diaSemana:r.dia_semana,horaInicio:r.hora_inicio,horaFin:r.hora_fin}),o))),this.view.resetForm(),await this.cargar()}catch(o){this.view.showError(o.message)}}async handleEditar(e){const o=this.tecnicos.find(n=>n.id===e);if(o){this.editando=o;try{const n=this.tokenProvider.getToken(),t=await p(o.id,n);this.view.fillForm({...o,horarios:t})}catch(n){this.view.showError(n.message)}}}async handleEliminar(e){if(confirm("¬øEliminar t√©cnico?"))try{const o=this.tokenProvider.getToken();await C(e,o),await this.cargar()}catch(o){this.view.showError(o.message)}}}document.addEventListener("DOMContentLoaded",async()=>{const i=new q;await new N({view:i,tokenProvider:T}).init()});
