<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Gestión de Turnos</title>
  <link rel="stylesheet" href="../css/turnos.css">
  <link rel="icon" type="image/png" href="../img/icono_logo.ico">
</head>
<body>

<!-- HEADER con toggle responsive -->
<header class="site-header">
  <div class="header-container">
    <!-- Logo -->
    <a href="../index.html" class="logo-link">
      <img src="../img/logo-transparente-tp-link-blanco.png" alt="Logo" class="logo">
    </a>

    <!-- Título -->
    <h1 class="site-title">Gestión de Turnos</h1>

    <!-- Botón toggle para pantallas chicas -->
    <button class="nav-toggle" id="navToggle" aria-label="Abrir menú">&#9776;</button>

    <!-- Menú de navegación -->
    <nav class="site-nav" id="siteNav">
      <ul>
        <li><a href="../index.html">Menú</a></li>
        <li><a href="../html/cliente.html">Clientes</a></li>
        <li><a href="../html/tecnico.html">Técnicos</a></li>
        <li><a href="../html/turno.html" class="active">Turnos</a></li>
        <li><a href="../html/agenda.html">Agenda</a></li>
      </ul>
    </nav>
  </div>
</header>

<!-- CONTENIDO PRINCIPAL -->
<main class="layout">
  <!-- Panel izquierdo -->
  <aside class="sidebar">
    <h2>Crear Turno</h2>
    <form id="formTurno" class="form-turno">

      <label for="selectTicket">Ticket</label>
      <select id="selectTicket" required></select>

      <label for="selectCliente">Cliente</label>
      <select id="selectCliente" required></select>

      <label for="selectTecnico">Tecnico</label>
      <select id="selectTecnico" required></select>

      <label for="selectT">Tipo de Turno</label>
      <select id="selectT" required></select>

      <label for="selectRango">Rango Horario</label>
      <select id="selectRango" required></select>

      <label for="selectEstadoTicket">Estado del ticket</label>
      <select id="selectEstadoTicket"></select>

      <button id="btnMostrarTurnos" type="button" class="btn-primary" onclick="enviarTicket()">Mostrar Turnos</button>
    </form>
  </aside>

  <!-- Panel derecho -->
  <section class="content">
    <h2>Turnos Disponibles</h2>
    <div id="turnosContainer" class="grilla-turnos"></div>

    <div id="historialTurnos" class="historial-turnos"></div>
  </section>
</main>

<!-- FOOTER -->
<footer class="footer">
  <div class="container">
    <p>&copy; 2025 S-Link | Gestión de Turnos</p>
  </div>
</footer>

<!-- Script de la app -->
<script type="module" src="../js/turno/turno.js"></script>

<!-- Script para el toggle -->
<script>
document.addEventListener("DOMContentLoaded", () => {
  const navToggle = document.getElementById("navToggle");
  const siteNav = document.getElementById("siteNav");

  navToggle.addEventListener("click", () => {
    siteNav.classList.toggle("open");
  });
});


async function enviarTicket() {
  const ticketData = {
    id_cliente: document.getElementById("selectCliente").value,
    ticket_id: document.getElementById("selectTicket").value,
    estado: document.getElementById("selectEstadoTicket").value
  };

  try {
  const response = await fetch('/api/agendar_visita.php', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({
      nombre: "Agenda",
      mensaje: {
        id_cliente: document.getElementById("selectCliente").value,
        ticket_id: document.getElementById("selectTicket").value,
        estado: document.getElementById("selectEstadoTicket").value
      }
    })
  });

  const text = await response.text(); // leemos texto crudo
  let data;

  try {
    data = JSON.parse(text); // intentamos parsear JSON
  } catch {
    console.warn("⚠️ La respuesta no es JSON. Respuesta completa:", text);
    data = { mensaje: text }; // fallback: lo tratamos como texto
  }

  console.log("✅ Respuesta del servidor:", data.mensaje);
  alert("Ticket enviado correctamente!");
} catch (error) {
  console.error("❌ Error enviando ticket:", error);
}
}


</script>

<script>
document.addEventListener("DOMContentLoaded", () => {
  // Leer parámetros de la URL
  const params = new URLSearchParams(window.location.search);
  const clienteId = params.get("cliente");
  const ticketId = params.get("ticket");

  // Esperar un momento a que turno.js cargue los selects
  setTimeout(() => {
    const selectCliente = document.getElementById("selectCliente");
    const selectTicket = document.getElementById("selectTicket");

    // Si existen los elementos y hay valores
    if (selectCliente && clienteId) {
      // Si el cliente existe entre las opciones, seleccionarlo
      const optionCliente = Array.from(selectCliente.options).find(opt => opt.value == clienteId);
      if (optionCliente) selectCliente.value = clienteId;
      else {
        // Si no está en la lista, lo agregamos
        const nuevaOpcion = document.createElement("option");
        nuevaOpcion.value = clienteId;
        nuevaOpcion.textContent = `Cliente ${clienteId}`;
        nuevaOpcion.selected = true;
        selectCliente.appendChild(nuevaOpcion);
      }
    }

    if (selectTicket && ticketId) {
      const optionTicket = Array.from(selectTicket.options).find(opt => opt.value == ticketId);
      if (optionTicket) selectTicket.value = ticketId;
      else {
        const nuevaOpcion = document.createElement("option");
        nuevaOpcion.value = ticketId;
        nuevaOpcion.textContent = `Ticket ${ticketId}`;
        nuevaOpcion.selected = true;
        selectTicket.appendChild(nuevaOpcion);
      }
    }
  }, 500); // medio segundo para dar tiempo a que renderSelect... cargue las opciones
});
</script>


</body>
</html>
